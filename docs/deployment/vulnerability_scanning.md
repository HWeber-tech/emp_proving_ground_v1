# Dependency vulnerability scanning

This runbook captures how we integrate dependency vulnerability scanning into the
EMP Professional Predator CI pipelines. The goal is to surface actionable
CVEs early while maintaining a documented allowlist for temporary exceptions.

## Tooling

We rely on [`pip-audit`](https://pypi.org/project/pip-audit/) to analyse the
Python dependency graph described in our requirements files. The helper script
`scripts/security/run_pip_audit.py` wraps the tool with repository-specific
behaviour:

- Both `requirements/base.txt` and `requirements/dev.txt` are scanned by
  default. Additional files can be provided with repeated `--requirement`
  flags.
- Results are parsed into a structured report so CI can upload JSON artefacts
  while operators receive a concise console summary.
- A YAML allowlist handles temporary exemptions with explicit reasons and
  optional expiry dates. Expired entries fail the run unless explicitly ignored.

## Usage

Run the helper locally before raising a PR or wire it into CI jobs:

```bash
python -m src.security.pip_audit_runner --report artifacts/pip_audit.json
```

Alternatively, call the thin wrapper in `scripts/security/run_pip_audit.py`:

```bash
python scripts/security/run_pip_audit.py --report artifacts/pip_audit.json
```

The command exits with a non-zero status when actionable vulnerabilities are
present or when an allowlisted vulnerability has passed its expiry. Use
`--ignore-expired-allowlist` to downgrade the latter to a warning during
transitional periods.

## Allowlist workflow

Temporary exemptions live in `config/security/pip_audit_allowlist.yaml`:

```yaml
ignored_vulnerabilities:
  - id: GHSA-xxxx-xxxx-xxxx
    reason: Waiting for upstream patch
    expires: 2025-03-31
```

Each entry must describe why the exemption exists and when it expires. When the
expiry passes, the audit script reports the vulnerability as actionable so teams
are forced to revisit the item. Remove unused entries as soon as the underlying
package is upgraded to keep the file authoritative.

## CI integration

Add a job that installs the development requirements, runs the helper, and
uploads the JSON artefact to your CI system. Example GitHub Actions snippet:

```yaml
- name: Install tooling
  run: pip install -r requirements/dev.txt
- name: Audit dependencies
  run: python scripts/security/run_pip_audit.py --report artifacts/pip_audit.json
- name: Upload audit report
  uses: actions/upload-artifact@v4
  with:
    name: pip-audit
    path: artifacts/pip_audit.json
```

The summary printed by the helper is designed to land in CI logs. Operators can
review suppressed vulnerabilities and their business justifications in the same
output without digging through artefacts.
